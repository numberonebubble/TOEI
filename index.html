<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Odd Earth Institute | Mission 2035</title>
    <style>
        /* --- CORE STYLES --- */
        :root {
            --bg: #050a10;
            --blue: #4a90e2;
            --green: #00ff88;
            --gold: #ffcc00;
            --purple: #bf00ff;
            --alert: #ff3333;
            --dim: #445566;
            --panel: rgba(5, 10, 16, 0.95);
        }

        body, html {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: #eee;
            font-family: 'Courier New', Courier, monospace;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        /* --- 3D CANVAS --- */
        #canvas-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }
        
        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 2;
        }

        /* --- NAVIGATION --- */
        .nav-bar {
            position: fixed;
            top: 0; left: 0; width: 100%;
            padding: 25px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            pointer-events: none;
        }
        
        .logo {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 2px;
            pointer-events: auto;
            cursor: pointer;
            border-bottom: 2px solid var(--alert); 
            padding-bottom: 5px;
        }

        .back-link {
            pointer-events: auto;
            cursor: pointer;
            color: var(--dim);
            text-transform: uppercase;
            font-size: 0.9rem;
            display: none; 
            transition: 0.3s;
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border: 1px solid var(--dim);
        }
        .back-link:hover { color: var(--gold); border-color: var(--gold); }

        /* --- SHARED LAYOUT --- */
        section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            box-sizing: border-box;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--dim);
            padding: 3rem;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            position: relative;
            z-index: 10;
        }

        h1 { font-size: 2.5rem; margin: 0 0 1.5rem; color: #fff; text-transform: uppercase; line-height: 1.1; }
        h2 { font-size: 1.8rem; margin: 0 0 1rem; color: #fff; text-transform: uppercase; }
        p { font-size: 1.1rem; line-height: 1.8; color: #aaa; margin-bottom: 1.5rem; }
        .highlight { color: #fff; font-weight: bold; }
        
        .label {
            display: inline-block;
            font-size: 0.7rem;
            padding: 4px 8px;
            border: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
            color: #888;
            letter-spacing: 2px;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* --- HOME SPECIFIC --- */
        #view-home {
            position: relative;
            z-index: 10;
            width: 100%;
            transition: opacity 0.6s ease;
        }
        
        .card.mission-hero { border-top: 4px solid var(--alert); text-align: center; } 
        .card.model { border-left: 4px solid var(--blue); }
        .card.garage { border-right: 4px solid var(--gold); text-align: right; }
        .card.menu { border-bottom: 4px solid var(--green); text-align: center; }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            width: 100%;
            margin-top: 50px;
        }
        .file-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--dim);
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        .file-item:hover {
            border-color: var(--blue);
            background: rgba(74, 144, 226, 0.1);
            transform: translateY(-5px);
        }
        .file-number { font-size: 0.8rem; color: var(--dim); display: block; margin-bottom: 10px; }
        .file-title { font-size: 1.1rem; color: #fff; text-transform: uppercase; display: block; }

        /* --- PROBLEM VIEW SPECIFIC --- */
        #view-problem {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            display: none; 
            opacity: 0;
            transition: opacity 0.6s ease;
            overflow-y: auto;
            background: rgba(5,10,16,0.8);
        }
        
        .problem-wrapper { width: 100%; }
        .problem-section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 10%;
        }
        .solution-section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 10%;
        }

        .detail-card {
            background: var(--panel);
            border: 1px solid var(--dim);
            padding: 3rem;
            max-width: 500px;
        }

        .stat-row {
            display: flex;
            gap: 40px;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px dashed var(--dim);
        }
        .stat-block .val { display: block; font-size: 2rem; color: #fff; font-weight: bold; }
        .stat-block .lbl { display: block; font-size: 0.8rem; color: var(--dim); text-transform: uppercase; }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .card, .detail-card { padding: 2rem; width: 100%; }
            .problem-section, .solution-section { padding: 80px 20px; justify-content: center; }
        }

    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="logo" onclick="navigateTo('home')">THE ODD EARTH INSTITUTE</div>
        <div class="back-link" id="back-btn" onclick="navigateTo('home')">← RETURN TO HQ</div>
    </div>

    <div id="canvas-container"></div>
    <div class="scanlines"></div>

    <div id="view-home">
        
        <section>
            <div class="card mission-hero">
                <span class="label" style="color:var(--alert); border-color:var(--alert);">The Mission</span>
                <h1>Zero Preventable Deaths by 2035.</h1>
                <p>This is not a slogan. It is an engineering challenge.</p>
                <p>We are a think tank dedicated to closing the gap between <span class="highlight">survival and circumstance.</span></p>
                <br>
                <small style="color:var(--dim)">SCROLL TO ANALYZE</small>
            </div>
        </section>

        <section>
            <div class="card model">
                <span class="label">The Insight</span>
                <h2>Frontier Mortality Models</h2>
                <p>We analyze global mortality data to find the signal in the noise. We know exactly <em>where</em> people are dying, and <em>why</em>.</p>
                <p>The data reveals a simple truth: <span class="highlight">The technology to save them already exists.</span> It's just too expensive, too big, or too far away.</p>
            </div>
        </section>

        <section>
            <div class="card garage">
                <span class="label">The Execution</span>
                <h2>Lateral Thinking</h2>
                <p>To hit the 2035 target, we cannot wait for new physics. We must use what we have, differently.</p>
                <p>We take withered, mature technologies and re-engineer them into accessible lifesavers. We treat the world's biggest problems like a garage project.</p>
            </div>
        </section>

        <section style="display: block; padding-top: 10vh;">
            <div class="card menu" style="margin: auto;">
                <span class="label">Initiatives</span>
                <h2>The 2035 Roadmap</h2>
                <p>Explore the active hardware solutions.</p>
                
                <div class="file-grid">
                    <div class="file-item" onclick="openProblem(0)">
                        <span class="file-number">INITIATIVE 01</span>
                        <span class="file-title">The Medical Paradox</span>
                    </div>
                    <div class="file-item" onclick="openProblem(1)">
                        <span class="file-number">INITIATIVE 02</span>
                        <span class="file-title">Trauma Response</span>
                    </div>
                    <div class="file-item" onclick="openProblem(2)">
                        <span class="file-number">INITIATIVE 03</span>
                        <span class="file-title">Forensic Blindspots</span>
                    </div>
                    <div class="file-item" onclick="openProblem(3)">
                        <span class="file-number">INITIATIVE 04</span>
                        <span class="file-title">Precision Medicine</span>
                    </div>
                    <div class="file-item" onclick="openProblem(4)">
                        <span class="file-number">INITIATIVE 05</span>
                        <span class="file-title">Lateral Diagnostics</span>
                    </div>
                </div>
            </div>
            <br><br><br><br>
        </section>
    </div>

    <div id="view-problem">
        <div class="problem-wrapper">
            <div class="problem-section">
                <div class="detail-card" id="prob-card">
                    <span class="label">THE GAP</span>
                    <h1 id="prob-title">Title</h1>
                    <p id="prob-content">Content</p>
                    <small>SCROLL FOR LATERAL SOLUTION ▼</small>
                </div>
            </div>

            <div class="solution-section">
                <div class="detail-card" id="sol-card" style="border-right: 4px solid var(--green); text-align: right;">
                    <span class="label" style="color:var(--green); border-color:var(--green);">THE FIX</span>
                    <h2 id="sol-title" style="color:var(--green)">Title</h2>
                    <p id="sol-content">Content</p>
                    <div class="stat-row" id="sol-stats" style="justify-content: flex-end;"></div>
                    <br>
                    <button onclick="window.open('https://linkedin.com','_blank')" style="background:transparent; border:1px solid var(--gold); color:var(--gold); padding:10px 20px; cursor:pointer;">FUND THIS INITIATIVE</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- DATA ---
        const caseFiles = [
            {   // 0. MEDICAL
                color: 'blue',
                problem: {
                    title: "The Medical Paradox",
                    content: "It’s odd that we have CT scanners that can literally see inside our brains but we have a large population that live too far away to use them. The mortality model shows distinct clusters of preventable death purely due to distance from heavy machinery.",
                    shape: 'scanner'
                },
                solution: {
                    title: "The Single Dot",
                    content: "We replaced the machine with a single thermochromatic dot on the forehead. It monitors vitals instantly using simple physics. No power. No waiting. Just a sticker.",
                    stats: `<div class="stat-block"><span class="val">99%</span><span class="lbl">Cheaper</span></div><div class="stat-block"><span class="val">100%</span><span class="lbl">Portable</span></div>`,
                    shape: 'dot'
                }
            },
            {   // 1. TRAUMA
                color: 'alert',
                problem: {
                    title: "First Responder Gap",
                    content: "The #1 cause of death for the working age is trauma. Our first responders are overworked. The data shows fatigue correlates directly with error rates in the field.",
                    shape: 'watch'
                },
                solution: {
                    title: "Companion Plants",
                    content: "We use bio-modified plants in the home that change color based on the occupant's stress pheromones. Passive, constant monitoring without the battery life anxiety.",
                    stats: `<div class="stat-block"><span class="val">Zero</span><span class="lbl">Power</span></div><div class="stat-block"><span class="val">24/7</span><span class="lbl">Active</span></div>`,
                    shape: 'plant'
                }
            },
            {   // 2. FORENSICS
                color: 'green',
                problem: {
                    title: "Forensic Blindspots",
                    content: "Dogs can identify human targets with 90% accuracy, yet we stick to slow lab tests with an 8% conviction rate. We are ignoring a biological sensor evolved over millions of years.",
                    shape: 'gel'
                },
                solution: {
                    title: "K9 Olfactory Data",
                    content: "We utilize trained dogs to map scent data in real-time. We digitize their biological output into admissible forensic evidence. Nature's nose, digitized.",
                    stats: `<div class="stat-block"><span class="val">90%</span><span class="lbl">Accuracy</span></div><div class="stat-block"><span class="val">Real</span><span class="lbl">Time</span></div>`,
                    shape: 'dog'
                }
            },
            {   // 3. GENOMICS
                color: 'purple',
                problem: {
                    title: "The Precision Trap",
                    content: "We abandoned Feynman’s idea for using electron microscopes to physically look at DNA. We rely on expensive chemical sequencing that takes days, pricing out 80% of the world.",
                    shape: 'helix'
                },
                solution: {
                    title: "Optical Crystals",
                    content: "We use basic salt crystallization. By observing how samples crystallize physically, we can screen for anomalies instantly for pennies. Physics over chemistry.",
                    stats: `<div class="stat-block"><span class="val">$50</span><span class="lbl">Cost</span></div><div class="stat-block"><span class="val">1hr</span><span class="lbl">Result</span></div>`,
                    shape: 'crystal'
                }
            },
            {   // 4. DIAGNOSTICS
                color: 'gold',
                problem: {
                    title: "Invasive Standards",
                    content: "We bleed into test tubes and call it “non-invasive”. We traumatize patients to get data we could get elsewhere. This fear barrier prevents early diagnosis.",
                    shape: 'tube'
                },
                solution: {
                    title: "Lateral Diagnostics",
                    content: "We utilize modified video game controllers to measure micro-tremors. We diagnose neuro-degenerative conditions while the patient plays a game.",
                    stats: `<div class="stat-block"><span class="val">0</span><span class="lbl">Needles</span></div><div class="stat-block"><span class="val">High</span><span class="lbl">Fun</span></div>`,
                    shape: 'controller'
                }
            }
        ];

        // --- 3D SETUP ---
        const PARTICLE_COUNT = 25000; // Increased for density
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050a10);
        scene.fog = new THREE.Fog(0x050a10, 15, 60);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 25;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        container.appendChild(renderer.domElement);

        // --- SHAPE GENERATION (STRUCTURED CHAOS) ---
        const rand = (min, max) => Math.random() * (max - min) + min;
        const createShapeData = () => ({ positions: [], colors: [] });
        
        const shapes = {
            earth: createShapeData(),   // Planet + Satellites
            graph: createShapeData(),   // Models
            workshop: createShapeData(),// Method
            network: createShapeData(), // Menu
            scanner: createShapeData(), dot: createShapeData(),
            watch: createShapeData(), plant: createShapeData(),
            gel: createShapeData(), dog: createShapeData(),
            helix: createShapeData(), crystal: createShapeData(),
            tube: createShapeData(), controller: createShapeData()
        };

        // HELPER: Add chaotic noise around any shape
        function addNoise(shape, count) {
            for(let i=0; i<count; i++) {
                const r = rand(15, 30);
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.random() * Math.PI;
                shape.positions.push(r*Math.sin(phi)*Math.cos(theta), r*Math.sin(phi)*Math.sin(theta), r*Math.cos(phi));
                shape.colors.push(0.1, 0.1, 0.15); // Dark background dust
            }
        }

        // 1. ODD EARTH (Planet + Pulsing Swarm)
        for(let i=0; i<PARTICLE_COUNT; i++) {
            if (i < PARTICLE_COUNT * 0.6) {
                // Core Planet (Dense)
                const u = Math.random(), v = Math.random();
                const theta = 2 * Math.PI * u;
                const phi = Math.acos(2 * v - 1);
                const r = 8; 
                shapes.earth.positions.push(r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
                if (Math.random() > 0.85) shapes.earth.colors.push(1, 0.8, 0); // City lights
                else shapes.earth.colors.push(0, 0.2, 0.3); // Ocean/Land
            } else {
                // Satellite Swarm (Chaotic Orbit)
                const r = rand(9, 16);
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.random() * Math.PI;
                shapes.earth.positions.push(r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
                shapes.earth.colors.push(0.8, 0.8, 0.9); // White/Blue satellites
            }
        }

        // 2. GRAPH (Mortality Models - Turbulent Surface)
        for(let i=0; i<PARTICLE_COUNT; i++) {
            if (i < PARTICLE_COUNT * 0.8) {
                const x = rand(-18, 18);
                const z = rand(-12, 12);
                // Complex wave function for data topology
                const y = (Math.sin(x*0.2) + Math.cos(z*0.3)) * 3 + Math.sin(Math.sqrt(x*x+z*z))*2;
                shapes.graph.positions.push(x, y - 3, z);
                // Heatmap coloring
                if (y > 3) shapes.graph.colors.push(1, 0.2, 0.2); // Red Hot
                else if (y < -3) shapes.graph.colors.push(0.2, 0.6, 1); // Blue Cold
                else shapes.graph.colors.push(0.5, 0.5, 0.8);
            } else {
                // Floating Data Points
                shapes.graph.positions.push(rand(-20,20), rand(5,15), rand(-10,10));
                shapes.graph.colors.push(0.3, 0.3, 0.3);
            }
        }

        // 3. WORKSHOP (Scattered Components)
        for(let i=0; i<PARTICLE_COUNT; i++) {
             // Create multiple clusters of "junk"
             const cluster = Math.floor(Math.random() * 5);
             let cx=0, cy=0, cz=0;
             if(cluster===0) { cx=-10; cy=5; }
             if(cluster===1) { cx=10; cy=-5; }
             if(cluster===2) { cx=0; cy=0; cz=5; }
             
             const r = rand(0, 4);
             shapes.workshop.positions.push(cx+rand(-r,r), cy+rand(-r,r), cz+rand(-r,r));
             shapes.workshop.colors.push(0, 1, 0.5); // Tech Green
        }

        // 4. NETWORK (Dense Grid)
        for(let i=0; i<PARTICLE_COUNT; i++) {
            if (i < PARTICLE_COUNT * 0.7) {
                const u=Math.random(), v=Math.random(), r=8, t=2*Math.PI*u, p=Math.acos(2*v-1);
                shapes.network.positions.push(r*Math.sin(p)*Math.cos(t), r*Math.sin(p)*Math.sin(t), r*Math.cos(p));
                shapes.network.colors.push(0, Math.random()>0.8?1:0.1, 0.5); 
            } else {
                // Connection Lines (Abstract)
                const x = rand(-20, 20);
                shapes.network.positions.push(x, rand(-10,10), rand(-5,5));
                shapes.network.colors.push(0.1, 0.1, 0.1);
            }
        }

        // --- PROBLEM SHAPES (Structured Chaos) ---
        
        // SCANNER (Ring + Debris)
        for(let i=0; i<PARTICLE_COUNT; i++) {
            if(i < PARTICLE_COUNT * 0.6) {
                const a=rand(0,Math.PI*2), r=rand(9,11); 
                shapes.scanner.positions.push(Math.cos(a)*r, Math.sin(a)*r, rand(-4,4)); 
                shapes.scanner.colors.push(0.2, 0.6, 1);
            } else {
                // Radiation/Scan noise
                shapes.scanner.positions.push(rand(-5,5), rand(-5,5), rand(-15,15));
                shapes.scanner.colors.push(0.1, 0.1, 0.2);
            }
        }
        
        // DOT (Dense Face + Noise)
        for(let i=0; i<PARTICLE_COUNT; i++) {
            if(i<800) { shapes.dot.positions.push(rand(-0.8,0.8), 3+rand(-0.8,0.8), 4.5+rand(0,0.5)); shapes.dot.colors.push(1,0,0); }
            else { 
                const u=Math.random(), v=Math.random(), t=2*Math.PI*u, p=Math.acos(2*v-1);
                const r = 7 + rand(-0.1, 0.1);
                shapes.dot.positions.push(r*Math.sin(p)*Math.cos(t), r*Math.sin(p)*Math.sin(t)*1.2, (Math.cos(p)>0?3:1)*Math.cos(p));
                shapes.dot.colors.push(0.1, 0.4, 0.2);
            }
        }

        // WATCH (Strap + Digital Cloud)
        for(let i=0; i<PARTICLE_COUNT; i++) {
             const r = Math.random();
             if (r < 0.5) { // The Watch
                 if (Math.random() < 0.5) { // Strap
                     const a = rand(0, Math.PI*2);
                     if(Math.abs(a)>0.5) shapes.watch.positions.push(Math.sin(a)*7, Math.cos(a)*7, rand(-2,2));
                     else shapes.watch.positions.push(rand(-3,3), 7, rand(-3,3)); // Face
                 } else { // Heartbeat
                    const x=rand(-3,3); let z=Math.abs(x)<1?Math.sin(x*10):0; shapes.watch.positions.push(x, 7, z); 
                 }
                 shapes.watch.colors.push(0.5, 0.5, 0.5);
             } else { // The Data Cloud
                 shapes.watch.positions.push(rand(-10,10), rand(-10,10), rand(-10,10));
                 shapes.watch.colors.push(1, 0, 0); // Red alert dust
             }
        }

        // PLANT (Organic + Spores)
        for(let i=0; i<PARTICLE_COUNT; i++) {
            if (i < PARTICLE_COUNT * 0.6) {
                const rr=rand(2,8), a=rand(0,Math.PI*2), y=rand(-8,8);
                shapes.plant.positions.push(Math.cos(a)*rr, y, Math.sin(a)*rr); 
                shapes.plant.colors.push(0, 1, 0.2);
            } else {
                // Spores floating
                shapes.plant.positions.push(rand(-12,12), rand(-12,12), rand(-12,12));
                shapes.plant.colors.push(0.5, 1, 0.5);
            }
        }

        // GEL -> DOG
        for(let i=0; i<PARTICLE_COUNT; i++) {
             shapes.gel.positions.push(rand(-8,8), rand(-10,10), rand(-1,1));
             shapes.gel.colors.push(0, Math.random(), 1);
             
             // Dog Voxel + Scent Trail
             if(i < PARTICLE_COUNT*0.5) {
                // Dog Shape
                const rr=Math.random(); let x,yy,z;
                if(rr<0.5) { x=rand(-4,4); yy=rand(-2,2); z=rand(-1.5,1.5); } else if(rr<0.7) { x=rand(4,6); yy=rand(1,3.5); z=rand(-1,1); } else if(rr<0.9) { x=(rand(-1,1)>0?3:-3); yy=rand(-6,-2); z=rand(-1,1); } else { x=rand(-6,-4); yy=rand(0,2); z=0; }
                shapes.dog.positions.push(x,yy,z); shapes.dog.colors.push(0.8, 0.5, 0.2);
             } else {
                 // Scent Trail
                 const t = i * 0.01;
                 shapes.dog.positions.push(Math.sin(t)*10 + rand(-2,2), Math.cos(t)*5 + rand(-2,2), rand(-5,5));
                 shapes.dog.colors.push(0, 1, 0); // Green Scent
             }
        }

        // HELIX -> CRYSTAL
        for(let i=0; i<PARTICLE_COUNT; i++) {
             // Helix + Soup
             if (i < PARTICLE_COUNT * 0.6) {
                const t=rand(-12,12); const s=Math.random()>0.5?0:Math.PI;
                shapes.helix.positions.push(Math.cos(t*1.5+s)*6, t*1.5, Math.sin(t*1.5+s)*6); 
                shapes.helix.colors.push(0.6,0,0.8);
             } else {
                 shapes.helix.positions.push(rand(-10,10), rand(-10,10), rand(-10,10));
                 shapes.helix.colors.push(0.1, 0.1, 0.3);
             }

             // Crystal + Refraction
             if (i < PARTICLE_COUNT * 0.6) {
                const s=rand(0,4);
                shapes.crystal.positions.push(rand(-4,4), rand(-4,4), rand(-4,4));
                shapes.crystal.colors.push(0, 1, 1);
             } else {
                 shapes.crystal.positions.push(rand(-15,15), rand(-15,15), rand(-15,15));
                 shapes.crystal.colors.push(1, 1, 1); // Light sparkles
             }
        }

        // TUBE -> CONTROLLER
        for(let i=0; i<PARTICLE_COUNT; i++) {
             shapes.tube.positions.push(Math.cos(rand(0,6))*3, rand(-6,6), Math.sin(rand(0,6))*3); shapes.tube.colors.push(1,0,0);
             
             // Controller
             if (i < PARTICLE_COUNT * 0.7) {
                const r=Math.random(); 
                if(r<0.4) shapes.controller.positions.push(rand(-7,-3), rand(-2,2), rand(-2,2)); 
                else if(r<0.8) shapes.controller.positions.push(rand(3,7), rand(-2,2), rand(-2,2)); 
                else shapes.controller.positions.push(rand(-3,3), rand(-1,1), rand(-1,1));
                shapes.controller.colors.push(1, 0.8, 0);
             } else {
                 // Game Pixels
                 shapes.controller.positions.push(rand(-12,12), rand(-8,8), rand(-5,5));
                 shapes.controller.colors.push(Math.random(), Math.random(), Math.random());
             }
        }

        // --- INIT MESH ---
        const geometry = new THREE.BufferGeometry();
        const posArr = new Float32Array(PARTICLE_COUNT*3);
        const colArr = new Float32Array(PARTICLE_COUNT*3);
        for(let i=0; i<PARTICLE_COUNT*3; i++) { posArr[i]=shapes.earth.positions[i]; colArr[i]=shapes.earth.colors[i]; }
        geometry.setAttribute('position', new THREE.BufferAttribute(posArr, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colArr, 3));
        const material = new THREE.PointsMaterial({ size: 0.12, vertexColors: true, transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending });
        const points = new THREE.Points(geometry, material);
        scene.add(points);

        // --- LOGIC ---
        let state = 'home';
        let currentPosTarget = shapes.earth.positions;
        let currentColTarget = shapes.earth.colors;
        let activeCaseIndex = -1;

        const homeView = document.getElementById('view-home');
        const problemView = document.getElementById('view-problem');
        const backBtn = document.getElementById('back-btn');

        // HOME SCROLL
        window.addEventListener('scroll', () => {
            if(state !== 'home') return;
            const idx = Math.round(window.scrollY / window.innerHeight);
            let target = 'earth';
            if(idx === 1) target = 'graph';
            if(idx === 2) target = 'workshop';
            if(idx >= 3) target = 'network';
            currentPosTarget = shapes[target].positions;
            currentColTarget = shapes[target].colors;
        });

        // PROBLEM SCROLL
        problemView.addEventListener('scroll', () => {
            if(state !== 'problem') return;
            const scroll = problemView.scrollTop;
            const h = window.innerHeight;
            const data = caseFiles[activeCaseIndex];
            
            if(scroll > h * 0.5) {
                currentPosTarget = shapes[data.solution.shape].positions;
                currentColTarget = shapes[data.solution.shape].colors;
            } else {
                currentPosTarget = shapes[data.problem.shape].positions;
                currentColTarget = shapes[data.problem.shape].colors;
            }
        });

        window.openProblem = function(index) {
            state = 'problem';
            activeCaseIndex = index;
            const data = caseFiles[index];

            document.getElementById('prob-card').style.borderLeftColor = `var(--${data.color})`;
            document.getElementById('prob-title').innerText = data.problem.title;
            document.getElementById('prob-content').innerText = data.problem.content;
            document.getElementById('sol-title').innerText = data.solution.title;
            document.getElementById('sol-content').innerText = data.solution.content;
            document.getElementById('sol-stats').innerHTML = data.solution.stats;

            homeView.style.opacity = 0;
            setTimeout(() => {
                homeView.style.display = 'none';
                problemView.style.display = 'block';
                backBtn.style.display = 'block';
                setTimeout(() => problemView.style.opacity = 1, 50);
                currentPosTarget = shapes[data.problem.shape].positions;
                currentColTarget = shapes[data.problem.shape].colors;
            }, 500);
        };

        window.navigateTo = function(dest) {
            if(dest === 'home') {
                state = 'home';
                problemView.style.opacity = 0;
                backBtn.style.display = 'none';
                setTimeout(() => {
                    problemView.style.display = 'none';
                    problemView.scrollTop = 0; 
                    homeView.style.display = 'block';
                    setTimeout(() => homeView.style.opacity = 1, 50);
                }, 500);
                currentPosTarget = shapes.earth.positions;
                currentColTarget = shapes.earth.colors;
            }
        };

        // --- ANIMATION ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            const p = geometry.attributes.position.array;
            const c = geometry.attributes.color.array;
            const speed = 0.05;

            let xOffset = 0;
            if (state === 'problem') {
                const scroll = problemView.scrollTop;
                const h = window.innerHeight;
                const progress = Math.min(Math.max(scroll / h, 0), 1);
                xOffset = 7 - (progress * 14); 
            }

            for(let i=0; i<PARTICLE_COUNT; i++) {
                const ix=i*3, iy=i*3+1, iz=i*3+2;
                p[ix] += (currentPosTarget[ix] + xOffset - p[ix]) * speed;
                p[iy] += (currentPosTarget[iy] - p[iy]) * speed;
                p[iz] += (currentPosTarget[iz] - p[iz]) * speed;
                c[ix] += (currentColTarget[ix] - c[ix]) * speed;
                c[iy] += (currentColTarget[iy] - c[iy]) * speed;
                c[iz] += (currentColTarget[iz] - c[iz]) * speed;
                p[ix] += Math.sin(time+p[iy])*0.003; 

                // SPECIAL ANIMATION: PULSING SATELLITES (Odd Earth)
                if(state==='home' && window.scrollY < window.innerHeight) {
                    // Affects the last 40% of particles (satellites)
                    if (i > PARTICLE_COUNT * 0.6) {
                        const pulse = 1 + Math.sin(time * 1.5 + i) * 0.01;
                        p[ix] *= pulse; p[iy] *= pulse; p[iz] *= pulse;
                    }
                }
            }
            geometry.attributes.position.needsUpdate = true;
            geometry.attributes.color.needsUpdate = true;

            if(state==='home') points.rotation.y += 0.001;
            else points.rotation.y = Math.sin(time*0.2)*0.1;

            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', ()=>{
            camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
