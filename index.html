<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Odd Earth Institute | Discipline Agnostic</title>
    <style>
        /* --- CORE STYLES --- */
        :root {
            --bg: #050a10;
            --blue: #4a90e2;
            --green: #00ff88;
            --gold: #ffcc00;
            --purple: #bf00ff;
            --alert: #ff3333;
            --dim: #445566;
            --panel: rgba(5, 10, 16, 0.95);
        }

        body, html {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: #eee;
            font-family: 'Courier New', Courier, monospace;
            width: 100%;
            overflow-x: hidden;
        }

        /* --- 3D CANVAS --- */
        #canvas-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }
        
        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 2;
        }

        /* --- NAVIGATION --- */
        .nav-bar {
            position: fixed;
            top: 0; left: 0; width: 100%;
            padding: 25px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            pointer-events: none;
        }
        
        .logo {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 2px;
            pointer-events: auto;
            cursor: pointer;
            border-bottom: 2px solid var(--purple); 
            padding-bottom: 5px;
        }

        .back-link {
            pointer-events: auto;
            cursor: pointer;
            color: var(--dim);
            text-transform: uppercase;
            font-size: 0.9rem;
            display: none; 
            transition: 0.3s;
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border: 1px solid var(--dim);
        }
        .back-link:hover { color: var(--gold); border-color: var(--gold); }

        /* --- SHARED LAYOUT --- */
        .scroll-section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            box-sizing: border-box;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--dim);
            padding: 3rem;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            position: relative;
            z-index: 10;
        }

        h1 { font-size: 2.5rem; margin: 0 0 1.5rem; color: #fff; text-transform: uppercase; line-height: 1.1; }
        h2 { font-size: 1.8rem; margin: 0 0 1rem; color: #fff; text-transform: uppercase; }
        p { font-size: 1.1rem; line-height: 1.8; color: #aaa; margin-bottom: 1.5rem; }
        .highlight { color: #fff; font-weight: bold; }
        
        .label {
            display: inline-block;
            font-size: 0.7rem;
            padding: 4px 8px;
            border: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
            color: #888;
            letter-spacing: 2px;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* --- HOME SPECIFIC --- */
        #view-home {
            position: relative;
            z-index: 10;
            width: 100%;
            transition: opacity 0.6s ease;
        }
        
        .card.mission-hero { border-top: 4px solid var(--purple); text-align: center; } 
        .card.model { border-left: 4px solid var(--blue); }
        .card.garage { border-right: 4px solid var(--green); text-align: right; }
        .card.menu { border-bottom: 4px solid var(--gold); text-align: center; }
        .card.submit { border: 1px solid var(--alert); text-align: center; }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            width: 100%;
            margin-top: 50px;
        }
        .file-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--dim);
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        .file-item:hover {
            border-color: var(--blue);
            background: rgba(74, 144, 226, 0.1);
            transform: translateY(-5px);
        }
        .file-number { font-size: 0.8rem; color: var(--dim); display: block; margin-bottom: 10px; }
        .file-title { font-size: 1.1rem; color: #fff; text-transform: uppercase; display: block; }

        /* --- PROBLEM VIEW SPECIFIC --- */
        #view-problem {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            display: none; 
            opacity: 0;
            transition: opacity 0.6s ease;
            overflow-y: auto;
            background: rgba(5,10,16,0.8);
        }
        
        .problem-wrapper { width: 100%; }
        .problem-section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 10%;
        }
        .solution-section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 10%;
        }

        .detail-card {
            background: var(--panel);
            border: 1px solid var(--dim);
            padding: 3rem;
            max-width: 500px;
        }

        .stat-row {
            display: flex;
            gap: 40px;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px dashed var(--dim);
        }
        .stat-block .val { display: block; font-size: 2rem; color: #fff; font-weight: bold; }
        .stat-block .lbl { display: block; font-size: 0.8rem; color: var(--dim); text-transform: uppercase; }

        .btn-action {
            display: inline-block;
            margin-top: 20px;
            padding: 15px 30px;
            border: 1px solid var(--gold);
            color: var(--gold);
            text-transform: uppercase;
            font-weight: bold;
            text-decoration: none;
            transition: 0.3s;
            cursor: pointer;
            background: transparent;
        }
        .btn-action:hover { background: var(--gold); color: #000; }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .card, .detail-card { padding: 2rem; width: 100%; }
            .problem-section, .solution-section { padding: 80px 20px; justify-content: center; }
        }

    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="logo" onclick="navigateTo('home')">THE ODD EARTH INSTITUTE</div>
        <div class="back-link" id="back-btn" onclick="navigateTo('home')">← RETURN TO WORKSHOP</div>
    </div>

    <div id="canvas-container"></div>
    <div class="scanlines"></div>

    <div id="view-home">
        
        <section class="scroll-section">
            <div class="card mission-hero">
                <span class="label" style="color:var(--purple); border-color:var(--purple);">Discipline Agnostic</span>
                <h1>Physics. Biology. Code.</h1>
                <p>We are the collision point where the <span class="highlight">DIY Bio-Lab</span> meets the <span class="highlight">Hardware Hackerspace</span>.</p>
                <p>We build anything, for anyone. We don't care what branch of science solves the problem, as long as the problem stays solved.</p>
                <br>
                <small style="color:var(--dim)">SCROLL TO ENTER</small>
            </div>
        </section>

        <section class="scroll-section">
            <div class="card model">
                <span class="label">The Scope</span>
                <h2>The Human Frontier</h2>
                <p>The "frontier" isn't space. It's the problems humans face every single day.</p>
                <p>From quality of life to basic survival. The frontier is defined by the struggle of the end-user, not the trends of the industry. <span class="highlight">We solve for the daily reality.</span></p>
            </div>
        </section>

        <section class="scroll-section">
            <div class="card garage">
                <span class="label">The Philosophy</span>
                <h2>Radical Empathy</h2>
                <p>We don't build from an ivory tower. We build because we've been there.</p>
                <p>Our solutions are human-centric because we have lived the problems. We are engineers, patients, citizens, and hackers building the world we need to exist in.</p>
            </div>
        </section>

        <section class="scroll-section" style="padding-top: 5vh;">
            <div class="card menu" style="margin: auto;">
                <span class="label">Open Source Library</span>
                <h2>The Blueprint</h2>
                <p>Explore our active open-source solutions.</p>
                
                <div class="file-grid">
                    <div class="file-item" onclick="openProblem(0)">
                        <span class="file-number">BUILD 01</span>
                        <span class="file-title">Stroke Detection</span>
                    </div>
                    <div class="file-item" onclick="openProblem(1)">
                        <span class="file-number">BUILD 02</span>
                        <span class="file-title">Pollution Detection</span>
                    </div>
                    <div class="file-item" onclick="openProblem(2)">
                        <span class="file-number">BUILD 03</span>
                        <span class="file-title">Forensic Evidence</span>
                    </div>
                    <div class="file-item" onclick="openProblem(3)">
                        <span class="file-number">BUILD 04</span>
                        <span class="file-title">Precision Cancer</span>
                    </div>
                    <div class="file-item" onclick="openProblem(4)">
                        <span class="file-number">BUILD 05</span>
                        <span class="file-title">Lateral Diagnostics</span>
                    </div>
                    <div class="file-item" onclick="openProblem(5)">
                        <span class="file-number">BUILD 06</span>
                        <span class="file-title">Hospital Infections</span>
                    </div>
                    <div class="file-item" onclick="openProblem(6)">
                        <span class="file-number">BUILD 07</span>
                        <span class="file-title">Pre-Eclampsia</span>
                    </div>
                    <div class="file-item" onclick="openProblem(7)">
                        <span class="file-number">BUILD 08</span>
                        <span class="file-title">Infant Monitoring</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="scroll-section">
            <div class="card submit">
                <span class="label" style="color:var(--alert); border-color:var(--alert);">Field Intelligence</span>
                <h2>We need your story.</h2>
                <p>We can only solve what we understand. If you are facing a problem that technology has failed to solve, tell us.</p>
                <p>Help us define the next frontier.</p>
                <a href="mailto:solutions@oddearth.org" class="btn-action">Submit A Problem</a>
            </div>
        </section>
    </div>

    <div id="view-problem">
        <div class="problem-wrapper">
            <div class="problem-section">
                <div class="detail-card" id="prob-card">
                    <span class="label">THE BARRIER</span>
                    <h1 id="prob-title">Title</h1>
                    <p id="prob-content">Content</p>
                    <small>SCROLL FOR DIY ALTERNATIVE ▼</small>
                </div>
            </div>

            <div class="solution-section">
                <div class="detail-card" id="sol-card" style="border-right: 4px solid var(--green); text-align: right;">
                    <span class="label" style="color:var(--green); border-color:var(--green);">THE HACK</span>
                    <h2 id="sol-title" style="color:var(--green)">Title</h2>
                    <p id="sol-content">Content</p>
                    <div class="stat-row" id="sol-stats" style="justify-content: flex-end;"></div>
                    <br>
                    <button class="btn-action" style="font-size: 0.8rem;">GET THE BLUEPRINTS</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- DATA ---
        const caseFiles = [
            {   // 0. MEDICAL
                color: 'blue',
                problem: {
                    title: "Stroke detection",
                    content: "Stroke detection currently relies on CT scanners. This equipment is expensive, immobile, and requires stable power grids. This limits access to 'Somewhere'—major cities in wealthy nations.",
                    shape: 'scanner'
                },
                solution: {
                    title: "Percussion.",
                    content: "We modernized a percussion technique using simple acoustic sensors. It detects density changes in the brain (clots/bleeds) using sound physics. It brings diagnostics 'Everywhere'.",
                    stats: `<div class="stat-block"><span class="val">Open</span><span class="lbl">Source</span></div><div class="stat-block"><span class="val">$50</span><span class="lbl">Build Cost</span></div>`,
                    shape: 'dot'
                }
            },
            {   // 1. TRAUMA
                color: 'alert',
                problem: {
                    title: "Invisible Pollution",
                    content: "Air pollution kills millions, but industrial monitoring stations are rare and expensive. We cannot fix what we cannot see or measure locally in our own homes.",
                    shape: 'watch'
                },
                solution: {
                    title: "Bio-Indicators",
                    content: "We genetically modify common house plants to change leaf color in the presence of specific VOCs. A self-replicating, zero-power sensor for every home.",
                    stats: `<div class="stat-block"><span class="val">Self</span><span class="lbl">Power</span></div><div class="stat-block"><span class="val">DIY</span><span class="lbl">Kit</span></div>`,
                    shape: 'plant'
                }
            },
            {   // 2. FORENSICS
                color: 'green',
                problem: {
                    title: "Forensic Barriers",
                    content: "DNA labs are slow and backlogged. Justice is often delayed or denied because forensic technology is centralized, proprietary, and bottlenecked.",
                    shape: 'gel'
                },
                solution: {
                    title: "Digital Nose",
                    content: "We utilize trained dogs and digitize their scent tracking data into admissible evidence. We turn a biological skill into a digital dataset.",
                    stats: `<div class="stat-block"><span class="val">90%</span><span class="lbl">Accuracy</span></div><div class="stat-block"><span class="val">Real</span><span class="lbl">Time</span></div>`,
                    shape: 'dog'
                }
            },
            {   // 3. GENOMICS
                color: 'purple',
                problem: {
                    title: "The Genomic Divide",
                    content: "Precision medicine relies on sequencers that cost thousands of dollars per run. This technology is effectively gated behind a wealth paywall.",
                    shape: 'helix'
                },
                solution: {
                    title: "Optical Screening",
                    content: "We use basic salt crystallization patterns to identify chemical anomalies in blood. It is a visual, physics-based pre-screen that costs pennies.",
                    stats: `<div class="stat-block"><span class="val">Low</span><span class="lbl">Tech</span></div><div class="stat-block"><span class="val">Fast</span><span class="lbl">Results</span></div>`,
                    shape: 'crystal'
                }
            },
            {   // 4. DIAGNOSTICS
                color: 'gold',
                problem: {
                    title: "Invasive Standards",
                    content: "Medical diagnostics rely on invasive procedures (needles, biopsies) that cause fear and require sterile clinical settings.",
                    shape: 'tube'
                },
                solution: {
                    title: "Gamified Vitals",
                    content: "We hack video game controllers to measure micro-tremors and reaction times. We diagnose neuro-degenerative conditions through gameplay logic.",
                    stats: `<div class="stat-block"><span class="val">0</span><span class="lbl">Needles</span></div><div class="stat-block"><span class="val">100%</span><span class="lbl">Accessible</span></div>`,
                    shape: 'controller'
                }
            },
            {   // 5. INFECTIONS
                color: 'alert',
                problem: {
                    title: "Diagnostic Lag",
                    content: "Waiting 48 hours for a PCR lab result to confirm a hospital infection allows sepsis to set in. The centralized lab model is too slow.",
                    shape: 'pcr'
                },
                solution: {
                    title: "The Optical IV",
                    content: "An open-source optical chip mountable on any standard IV line. It detects bacterial refraction in fluids in real-time.",
                    stats: `<div class="stat-block"><span class="val">Open</span><span class="lbl">Hardware</span></div><div class="stat-block"><span class="val">Instant</span><span class="lbl">Alert</span></div>`,
                    shape: 'chip'
                }
            },
            {   // 6. PRE-ECLAMPSIA
                color: 'purple',
                problem: {
                    title: "Rural Access",
                    content: "High-risk pregnancies require frequent monitoring that currently only exists in large, central hospitals.",
                    shape: 'lab'
                },
                solution: {
                    title: "The Heart Patch",
                    content: "A low-cost wearable patch that monitors Heart Rate Variability (HRV) to predict pre-eclampsia onset days in advance from home.",
                    stats: `<div class="stat-block"><span class="val">Home</span><span class="lbl">Fab</span></div><div class="stat-block"><span class="val">Early</span><span class="lbl">Warning</span></div>`,
                    shape: 'patch'
                }
            },
            {   // 7. INFANT MONITORING
                color: 'blue',
                problem: {
                    title: "Barriers to Care",
                    content: "Wired monitoring systems create physical barriers between infants and parents, and require expensive proprietary cables.",
                    shape: 'crib'
                },
                solution: {
                    title: "Acoustic AI",
                    content: "We use cheap, off-the-shelf microphones and open-source AI to analyze cry frequencies for pain and hunger. Zero wires.",
                    stats: `<div class="stat-block"><span class="val">100%</span><span class="lbl">Wireless</span></div><div class="stat-block"><span class="val">Free</span><span class="lbl">Code</span></div>`,
                    shape: 'speaker'
                }
            }
        ];

        // --- 3D SETUP ---
        const PARTICLE_COUNT = 25000;
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050a10);
        scene.fog = new THREE.Fog(0x050a10, 15, 60);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 25;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        container.appendChild(renderer.domElement);

        // --- SHAPE GENERATION ---
        const rand = (min, max) => Math.random() * (max - min) + min;
        const createShapeData = () => ({ positions: [], colors: [] });
        
        const shapes = {
            earth: createShapeData(),   // Home 1
            graph: createShapeData(),   // Home 2
            workshop: createShapeData(),// Home 3
            network: createShapeData(), // Home 4
            envelope: createShapeData(),// Home 5 (Submit)
            
            // Cases
            scanner: createShapeData(), dot: createShapeData(),
            watch: createShapeData(), plant: createShapeData(),
            gel: createShapeData(), dog: createShapeData(),
            helix: createShapeData(), crystal: createShapeData(),
            tube: createShapeData(), controller: createShapeData(),
            pcr: createShapeData(), chip: createShapeData(),
            lab: createShapeData(), patch: createShapeData(),
            crib: createShapeData(), speaker: createShapeData()
        };

        // --- 1. ODD EARTH GENERATION ---
        for(let i=0; i<PARTICLE_COUNT; i++) {
            if (i < PARTICLE_COUNT * 0.7) {
                const u = Math.random(), v = Math.random(), theta = 2 * Math.PI * u, phi = Math.acos(2 * v - 1), r = 8.5; 
                shapes.earth.positions.push(r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
                if (Math.abs(r * Math.sin(phi) * Math.sin(theta)) < 3 && Math.random() > 0.6) shapes.earth.colors.push(0.0, 0.8, 0.5); else shapes.earth.colors.push(0.0, 0.1, 0.4);
            } else if (i < PARTICLE_COUNT * 0.85) {
                const u = Math.random(), v = Math.random(), theta = 2 * Math.PI * u, phi = Math.acos(2 * v - 1), r = 9.0; 
                shapes.earth.positions.push(r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
                shapes.earth.colors.push(1.0, 0.8, 0.0);
            } else {
                const band = Math.floor(Math.random() * 3), angle = Math.random() * Math.PI * 2, r = 11 + Math.random();
                let x,y,z;
                if(band === 0) { x = Math.cos(angle)*r; z = Math.sin(angle)*r; y = rand(-1, 1); }
                else if (band === 1) { y = Math.cos(angle)*r; z = Math.sin(angle)*r; x = rand(-1, 1); }
                else { const base = Math.cos(angle)*r; x = base; y = base; z = Math.sin(angle)*r; }
                shapes.earth.positions.push(x, y, z);
                shapes.earth.colors.push(1.0, 1.0, 1.0); 
            }
        }

        // 2. GRAPH
        for(let i=0; i<PARTICLE_COUNT; i++) {
            if (i < PARTICLE_COUNT * 0.8) {
                const x = rand(-18, 18), z = rand(-12, 12), y = (Math.sin(x*0.2) + Math.cos(z*0.3)) * 3 + Math.sin(Math.sqrt(x*x+z*z))*2;
                shapes.graph.positions.push(x, y - 3, z);
                if (y > 3) shapes.graph.colors.push(1, 0.2, 0.2); else if (y < -3) shapes.graph.colors.push(0.2, 0.6, 1); else shapes.graph.colors.push(0.5, 0.5, 0.8);
            } else { shapes.graph.positions.push(rand(-20,20), rand(5,15), rand(-10,10)); shapes.graph.colors.push(0.3, 0.3, 0.3); }
        }

        // 3. WORKSHOP
        for(let i=0; i<PARTICLE_COUNT; i++) {
             const cluster = Math.floor(Math.random() * 5); let cx=0, cy=0, cz=0;
             if(cluster===0) { cx=-10; cy=5; } if(cluster===1) { cx=10; cy=-5; } if(cluster===2) { cx=0; cy=0; cz=5; }
             const r = rand(0, 4); shapes.workshop.positions.push(cx+rand(-r,r), cy+rand(-r,r), cz+rand(-r,r)); shapes.workshop.colors.push(0, 1, 0.5); 
        }

        // 4. NETWORK
        for(let i=0; i<PARTICLE_COUNT; i++) {
            if (i < PARTICLE_COUNT * 0.7) {
                const u=Math.random(), v=Math.random(), r=8, t=2*Math.PI*u, p=Math.acos(2*v-1);
                shapes.network.positions.push(r*Math.sin(p)*Math.cos(t), r*Math.sin(p)*Math.sin(t), r*Math.cos(p));
                shapes.network.colors.push(0, Math.random()>0.8?1:0.1, 0.5); 
            } else { shapes.network.positions.push(rand(-20, 20), rand(-10,10), rand(-5,5)); shapes.network.colors.push(0.1, 0.1, 0.1); }
        }

        // 5. ENVELOPE (Submit)
        for(let i=0; i<PARTICLE_COUNT; i++) {
            // Rect Body
            if(i < PARTICLE_COUNT * 0.6) {
                shapes.envelope.positions.push(rand(-6,6), rand(-4,4), 0);
                shapes.envelope.colors.push(1, 0.8, 0); // Gold Envelope
            } 
            // Flap (Triangle)
            else if (i < PARTICLE_COUNT * 0.8) {
                const x = rand(-6,6);
                // Simple triangle logic: y goes from 4 down to 0 as x goes from -6 to 6
                // Top line
                shapes.envelope.positions.push(x, 4 - Math.abs(x)*0.6, 0.5); 
                shapes.envelope.colors.push(1, 0.6, 0);
            }
            // Incoming Letters (Particles)
            else {
                shapes.envelope.positions.push(rand(-15,15), rand(5,15), rand(-5,5));
                shapes.envelope.colors.push(1, 1, 1);
            }
        }

        // --- PROBLEM SHAPES ---
        // Scanner -> Dot
        for(let i=0; i<PARTICLE_COUNT; i++) {
            if(i < PARTICLE_COUNT * 0.6) { const a=rand(0,Math.PI*2), r=rand(9,11); shapes.scanner.positions.push(Math.cos(a)*r, Math.sin(a)*r, rand(-4,4)); shapes.scanner.colors.push(0.2, 0.6, 1); } else { shapes.scanner.positions.push(rand(-5,5), rand(-5,5), rand(-15,15)); shapes.scanner.colors.push(0.1, 0.1, 0.2); }
            if(i<800) { shapes.dot.positions.push(rand(-0.8,0.8), 3+rand(-0.8,0.8), 4.5+rand(0,0.5)); shapes.dot.colors.push(1,0,0); } else { const u=Math.random(), v=Math.random(), t=2*Math.PI*u, p=Math.acos(2*v-1); const r = 7 + rand(-0.1, 0.1); shapes.dot.positions.push(r*Math.sin(p)*Math.cos(t), r*Math.sin(p)*Math.sin(t)*1.2, (Math.cos(p)>0?3:1)*Math.cos(p)); shapes.dot.colors.push(0.1, 0.4, 0.2); }
        }
        // Watch -> Plant
        for(let i=0; i<PARTICLE_COUNT; i++) {
             const r = Math.random();
             if (r < 0.5) { if (Math.random() < 0.5) { const a = rand(0, Math.PI*2); if(Math.abs(a)>0.5) shapes.watch.positions.push(Math.sin(a)*7, Math.cos(a)*7, rand(-2,2)); else shapes.watch.positions.push(rand(-3,3), 7, rand(-3,3)); } else { const x=rand(-3,3); let z=Math.abs(x)<1?Math.sin(x*10):0; shapes.watch.positions.push(x, 7, z); } shapes.watch.colors.push(0.5, 0.5, 0.5); } else { shapes.watch.positions.push(rand(-10,10), rand(-10,10), rand(-10,10)); shapes.watch.colors.push(1, 0, 0); }
             if (i < PARTICLE_COUNT * 0.6) { const rr=rand(2,8), a=rand(0,Math.PI*2), y=rand(-8,8); shapes.plant.positions.push(Math.cos(a)*rr, y, Math.sin(a)*rr); shapes.plant.colors.push(0, 1, 0.2); } else { shapes.plant.positions.push(rand(-12,12), rand(-12,12), rand(-12,12)); shapes.plant.colors.push(0.5, 1, 0.5); }
        }
        // Gel -> Dog
        for(let i=0; i<PARTICLE_COUNT; i++) {
             shapes.gel.positions.push(rand(-8,8), rand(-10,10), rand(-1,1)); shapes.gel.colors.push(0, Math.random(), 1);
             if(i < PARTICLE_COUNT*0.5) { const rr=Math.random(); let x,yy,z; if(rr<0.5) { x=rand(-4,4); yy=rand(-2,2); z=rand(-1.5,1.5); } else if(rr<0.7) { x=rand(4,6); yy=rand(1,3.5); z=rand(-1,1); } else if(rr<0.9) { x=(rand(-1,1)>0?3:-3); yy=rand(-6,-2); z=rand(-1,1); } else { x=rand(-6,-4); yy=rand(0,2); z=0; } shapes.dog.positions.push(x,yy,z); shapes.dog.colors.push(0.8, 0.5, 0.2); } else { const t = i * 0.01; shapes.dog.positions.push(Math.sin(t)*10 + rand(-2,2), Math.cos(t)*5 + rand(-2,2), rand(-5,5)); shapes.dog.colors.push(0, 1, 0); }
        }
        // Helix -> Crystal
        for(let i=0; i<PARTICLE_COUNT; i++) {
             if (i < PARTICLE_COUNT * 0.6) { const t=rand(-12,12); const s=Math.random()>0.5?0:Math.PI; shapes.helix.positions.push(Math.cos(t*1.5+s)*6, t*1.5, Math.sin(t*1.5+s)*6); shapes.helix.colors.push(0.6,0,0.8); } else { shapes.helix.positions.push(rand(-10,10), rand(-10,10), rand(-10,10)); shapes.helix.colors.push(0.1, 0.1, 0.3); }
             if (i < PARTICLE_COUNT * 0.6) { const s=rand(0,4); shapes.crystal.positions.push(rand(-4,4), rand(-4,4), rand(-4,4)); shapes.crystal.colors.push(0, 1, 1); } else { shapes.crystal.positions.push(rand(-15,15), rand(-15,15), rand(-15,15)); shapes.crystal.colors.push(1, 1, 1); }
        }
        // Tube -> Controller
        for(let i=0; i<PARTICLE_COUNT; i++) {
             shapes.tube.positions.push(Math.cos(rand(0,6))*3, rand(-6,6), Math.sin(rand(0,6))*3); shapes.tube.colors.push(1,0,0);
             if (i < PARTICLE_COUNT * 0.7) { const r=Math.random(); if(r<0.4) shapes.controller.positions.push(rand(-7,-3), rand(-2,2), rand(-2,2)); else if(r<0.8) shapes.controller.positions.push(rand(3,7), rand(-2,2), rand(-2,2)); else shapes.controller.positions.push(rand(-3,3), rand(-1,1), rand(-1,1)); shapes.controller.colors.push(1, 0.8, 0); } else { shapes.controller.positions.push(rand(-12,12), rand(-8,8), rand(-5,5)); shapes.controller.colors.push(Math.random(), Math.random(), Math.random()); }
        }
        // PCR -> Chip
        for(let i=0; i<PARTICLE_COUNT; i++) {
            if(i < PARTICLE_COUNT * 0.6) { const x = rand(-4, 4); const y = rand(-4, 2); const z = rand(-4, 4); shapes.pcr.positions.push(x, y, z); if(y>1) shapes.pcr.colors.push(0.8, 0.8, 0.9); else shapes.pcr.colors.push(0.3, 0.3, 0.4); } else { shapes.pcr.positions.push(rand(-10,10), rand(-10,10), rand(-10,10)); shapes.pcr.colors.push(0.1, 0.1, 0.1); }
            if(i < PARTICLE_COUNT * 0.2) { shapes.chip.positions.push(rand(-0.2,0.2), rand(-10,10), rand(-0.2,0.2)); shapes.chip.colors.push(0.5, 0.8, 1); } else if (i < PARTICLE_COUNT * 0.5) { shapes.chip.positions.push(rand(-2,2), rand(-1,1), rand(0, 0.5)); shapes.chip.colors.push(0, 1, 0.5); } else { shapes.chip.positions.push(rand(-15,15), rand(-15,15), rand(-15,15)); shapes.chip.colors.push(0.5, 0.5, 0.5); }
        }
        // Lab -> Patch
        for(let i=0; i<PARTICLE_COUNT; i++) {
            if(i < PARTICLE_COUNT * 0.7) { const x = rand(-12, 12); const z = rand(-5, 5); let y = 0; if(Math.abs(x) > 8) y = rand(-5, 5); else y = rand(-5, -2); shapes.lab.positions.push(x, y, z); shapes.lab.colors.push(0.8, 0.8, 0.9); } else { shapes.lab.positions.push(rand(-15,15), rand(-15,15), rand(-15,15)); shapes.lab.colors.push(0.2, 0.2, 0.3); }
            if(i < PARTICLE_COUNT * 0.6) { const t = Math.random() * Math.PI * 2; const x = 16 * Math.pow(Math.sin(t), 3); const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t); shapes.patch.positions.push(x*0.3, y*0.3, rand(0,1)); shapes.patch.colors.push(1, 0.2, 0.4); } else { shapes.patch.positions.push(rand(-10,10), rand(-10,10), rand(-10,10)); shapes.patch.colors.push(0.5, 0.1, 0.2); }
        }
        // Crib -> Speaker
        for(let i=0; i<PARTICLE_COUNT; i++) {
            if(i < PARTICLE_COUNT * 0.6) { const x = rand(-5, 5); const z = rand(-3, 3); let y = -3; if(Math.abs(x)>4 || Math.abs(z)>2) y = rand(-3, 3); shapes.crib.positions.push(x, y, z); shapes.crib.colors.push(0.7, 0.7, 0.8); } else { shapes.crib.positions.push(rand(-2,2), rand(-2,0), rand(-1,1)); shapes.crib.colors.push(1, 0.8, 0.6); }
            if(i < PARTICLE_COUNT * 0.6) { const r = rand(1, 6); const angle = rand(0, Math.PI*2); shapes.speaker.positions.push(Math.cos(angle)*r, Math.sin(angle)*r, r - 3); shapes.speaker.colors.push(0.2, 0.2, 0.2); } else { const r = rand(8, 15); const angle = rand(0, Math.PI*2); shapes.speaker.positions.push(Math.cos(angle)*r, Math.sin(angle)*r, r); shapes.speaker.colors.push(0, 1, 1); }
        }

        // --- INIT MESH ---
        const geometry = new THREE.BufferGeometry();
        const posArr = new Float32Array(PARTICLE_COUNT*3);
        const colArr = new Float32Array(PARTICLE_COUNT*3);
        for(let i=0; i<PARTICLE_COUNT*3; i++) { posArr[i]=shapes.earth.positions[i]; colArr[i]=shapes.earth.colors[i]; }
        geometry.setAttribute('position', new THREE.BufferAttribute(posArr, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colArr, 3));
        const material = new THREE.PointsMaterial({ size: 0.12, vertexColors: true, transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending });
        const points = new THREE.Points(geometry, material);
        scene.add(points);

        // --- LOGIC ---
        let state = 'home';
        let currentPosTarget = shapes.earth.positions;
        let currentColTarget = shapes.earth.colors;
        let activeCaseIndex = -1;

        const homeView = document.getElementById('view-home');
        const problemView = document.getElementById('view-problem');
        const backBtn = document.getElementById('back-btn');

        // --- FIXED HOME SCROLL LOGIC ---
        const homeSections = document.querySelectorAll('.scroll-section');
        
        window.addEventListener('scroll', () => {
            if(state !== 'home') return;
            
            let maxVisible = 0;
            let activeIdx = 0;
            
            homeSections.forEach((sec, i) => {
                const rect = sec.getBoundingClientRect();
                const visibleH = Math.min(rect.bottom, window.innerHeight) - Math.max(rect.top, 0);
                if(visibleH > maxVisible) {
                    maxVisible = visibleH;
                    activeIdx = i;
                }
            });

            let target = 'earth';
            if(activeIdx === 1) target = 'graph';
            if(activeIdx === 2) target = 'workshop';
            if(activeIdx === 3) target = 'network';
            if(activeIdx === 4) target = 'envelope';

            currentPosTarget = shapes[target].positions;
            currentColTarget = shapes[target].colors;
        });

        // PROBLEM SCROLL
        problemView.addEventListener('scroll', () => {
            if(state !== 'problem') return;
            const scroll = problemView.scrollTop;
            const h = window.innerHeight;
            const data = caseFiles[activeCaseIndex];
            
            if(scroll > h * 0.5) {
                currentPosTarget = shapes[data.solution.shape].positions;
                currentColTarget = shapes[data.solution.shape].colors;
            } else {
                currentPosTarget = shapes[data.problem.shape].positions;
                currentColTarget = shapes[data.problem.shape].colors;
            }
        });

        window.openProblem = function(index) {
            state = 'problem';
            activeCaseIndex = index;
            const data = caseFiles[index];

            document.getElementById('prob-card').style.borderLeftColor = `var(--${data.color})`;
            document.getElementById('prob-title').innerText = data.problem.title;
            document.getElementById('prob-content').innerText = data.problem.content;
            document.getElementById('sol-title').innerText = data.solution.title;
            document.getElementById('sol-content').innerText = data.solution.content;
            document.getElementById('sol-stats').innerHTML = data.solution.stats;

            homeView.style.opacity = 0;
            setTimeout(() => {
                homeView.style.display = 'none';
                problemView.style.display = 'block';
                backBtn.style.display = 'block';
                setTimeout(() => problemView.style.opacity = 1, 50);
                currentPosTarget = shapes[data.problem.shape].positions;
                currentColTarget = shapes[data.problem.shape].colors;
            }, 500);
        };

        window.navigateTo = function(dest) {
            if(dest === 'home') {
                state = 'home';
                problemView.style.opacity = 0;
                backBtn.style.display = 'none';
                setTimeout(() => {
                    problemView.style.display = 'none';
                    problemView.scrollTop = 0; 
                    homeView.style.display = 'block';
                    setTimeout(() => homeView.style.opacity = 1, 50);
                }, 500);
                currentPosTarget = shapes.earth.positions;
                currentColTarget = shapes.earth.colors;
            }
        };

        // --- ANIMATION ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            const p = geometry.attributes.position.array;
            const c = geometry.attributes.color.array;
            const speed = 0.05;

            let xOffset = 0;
            if (state === 'problem') {
                const scroll = problemView.scrollTop;
                const h = window.innerHeight;
                const progress = Math.min(Math.max(scroll / h, 0), 1);
                xOffset = 7 - (progress * 14); 
            }

            for(let i=0; i<PARTICLE_COUNT; i++) {
                const ix=i*3, iy=i*3+1, iz=i*3+2;
                p[ix] += (currentPosTarget[ix] + xOffset - p[ix]) * speed;
                p[iy] += (currentPosTarget[iy] - p[iy]) * speed;
                p[iz] += (currentPosTarget[iz] - p[iz]) * speed;
                c[ix] += (currentColTarget[ix] - c[ix]) * speed;
                c[iy] += (currentColTarget[iy] - c[iy]) * speed;
                c[iz] += (currentColTarget[iz] - c[iz]) * speed;
                p[ix] += Math.sin(time+p[iy])*0.003; 

                // SPECIAL ANIMATION: PULSING SATELLITES
                if(state==='home' && window.scrollY < window.innerHeight) {
                    if (i > PARTICLE_COUNT * 0.7) {
                        const pulse = 1 + Math.sin(time * 1.5 + i) * 0.01;
                        p[ix] *= pulse; p[iy] *= pulse; p[iz] *= pulse;
                    }
                }
            }
            geometry.attributes.position.needsUpdate = true;
            geometry.attributes.color.needsUpdate = true;

            if(state==='home') points.rotation.y += 0.001;
            else points.rotation.y = Math.sin(time*0.2)*0.1;

            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', ()=>{
            camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
